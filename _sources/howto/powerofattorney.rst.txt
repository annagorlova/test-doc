Работа с машиночитаемой доверенностью
=====================================

.. contents:: :local:

С 1 марта 2022 года вступают в силу поправки в `Федеральный закон от 06.04.2011 № 63-ФЗ <https://normativ.kontur.ru/document?moduleId=1&documentId=416095>`__. Изменения заключаются том, что для подписания документов сотрудники компаний могут использовать сертификаты физического лица, в которых указаны только их личные данные без указания принадлежности к организации. Однако только подписи физического лица при обмене документами недостаточно, чтобы вести юридически значимый документооборот организации. Для подтверждения полномочий сотрудника и его принадлежности к компании руководитель должен выпустить машиночитаемую доверенность (МЧД).

**Машиночитаемая доверенность** — это электронный документ в формате XML, используя который руководитель организации передает сотруднику полномочия для подписания документов. С помощью МЧД сотрудники могут ставить подписи от лица организации.
Документ содержит данные о:

- доверителе — организации, которая выдала доверенность,
- доверенном лице — физическом лице, которое уполномочено совершать действие,
- полномочиях сотрудника.

МЧД нужно передавать вместе с каждым документом, который был подписан сертификатом физического лица. Она будет использоваться при подписании документа и действиях с документом:

- отказ в подписи,
- запрос аннулирования,
- отказ в аннулировании,
- аннулирование,
- запрос уточнения,
- подписание извещения о получении документа.

Сотрудники и уполномоченные лица организаций могут перейти на новый формат подписания документов — использовать сертификат физического лица и прикладывать к нему МЧД.

.. note::

	На время переходного периода, пока МЧД не является обязательным требованием, использовать МЧД с сертификатом физического лица не обязательно.
 
Процесс работы с МЧД в Диадоке может быть представлен следующими этапами:

.. contents:: :local:
	:depth: 1


Управление доверенностями
-------------------------

Чтобы сотрудник мог использовать МЧД при работе с документами, ее нужно зарегистрировать и привязать к сотруднику в Диадоке. Это может сделать администратор ящика организации или сам сотрудник. Для этого нужно:

- выпустить доверенность в специальном сервисе: Диадок не выпускает МЧД;
- получить информацию о МЧД для ее добавления в Диадок: *XML-файл МЧД + ЭП руководителя* или *регистрационный номер МЧД + ИНН доверителя*;
- :ref:`зарегистрировать МЧД в Диадоке <powerofattorney_register>`;
- :ref:`привязать МЧД к сотруднику <powerofattorney_employee>`;
- :ref:`установить МЧД по умолчанию <powerofattorney_employee>`, чтобы не выбирать ее при каждом действии с документами (необязательно).

Кроме этого Диадок позволяет :ref:`управлять <powerofattorney_employee>` уже привязанными к сотруднику доверенностями:

- получить список МЧД, привязанных к сотруднику,
- отвязать МЧД от сотрудника,
- изменить для МЧД настройку «по умолчанию».


.. _powerofattorney_register:

Регистрация МЧД
~~~~~~~~~~~~~~~

Если у вас есть МЧД и вы хотите использовать ее для работы в Диадоке, ее нужно зарегистрировать. Сделать это можно двумя способами:

- используя регистрационный номер МЧД и ИНН доверителя,
- используя XML-файл МЧД с электронной подписью руководителя.

Для регистрации МЧД вызовите метод :doc:`../http/RegisterPowerOfAttorney`, который вернет идентификатор задачи ``taskId``. По этому идентификатору с помощью метода :doc:`../http/RegisterPowerOfAttorneyResult` можно узнать результат регистрации.

Зарегистрированную МЧД нужно привязать к сотруднику, чтобы использовать ее для выполнения операций в Диадоке.


.. _powerofattorney_employee:

Работа с МЧД сотрудника
~~~~~~~~~~~~~~~~~~~~~~~		

Чтобы сотрудник мог использовать МЧД, она должна быть привязана к этому сотруднику. К каждому сотруднику может быть привязано несколько МЧД. Любую из них можно использовать как доверенность по умолчанию. Пользователь может в любой момент может сделать доверенностью по умолчанию другую МЧД или убрать доверенность по умолчанию совсем. Любую МЧД, уже привязанную к сотруднику, можно отвязать.

Работать с МЧД сотрудника можно с помощью методов:

- метод :doc:`../http/AddEmployeePowerOfAttorney` привязывает МЧД к сотруднику;
- метод :doc:`../http/DeleteEmployeePowerOfAttorney` отвязывает МЧД от сотрудника;
- метод :doc:`../http/UpdateEmployeePowerOfAttorney` устанавливает сотруднику доверенность по умолчанию или снимает с доверенности такой признак;
- метод :doc:`../http/GetEmployeePowersOfAttorney` возвращает список всех МЧД, привязанных к сотруднику.


Формирование документа
----------------------

При формировании формализованного документа нужно учесть МЧД в блоке ``Подписант``. Для этого вместе с сертификатом физического лица укажите МЧД:

- при генерации :ref:`титула с МЧД <generate_title_xml_poa>` методом :doc:`../http/GenerateTitleXml`;
- при подготовке документа к подписанию методом :doc:`../http/PrepareDocumentsToSign`: для этого в структуре :doc:`../proto/utd/ExtendedSigner` заполните структуру :doc:`../proto/PowerOfAttorneyToPost`, указав в ней данные о МЧД.


Предварительная проверка МЧД
----------------------------

Перед отправкой документа можно проверить МЧД:

- соответствует ли МЧД установленному формату,
- является ли МЧД действующей (без учета отзыва),
- верна ли подпись, которой подписана МЧД,
- соответствует ли МЧД сертификату, которым будет подписан документ,
- отозвана ли МЧД — проверяется в тех случаях, когда за отведенное время удастся получить информацию о статусе МЧД от сервиса ФНС.

Для предварительной проверки МЧД используйте метод :doc:`../http/PrevalidatePowerOfAttorney`.


Отправка документа
------------------

Для отправки документа вызовите метод :doc:`../http/PostMessage` или :doc:`../http/SendDraft`, указав в теле запроса регистрационный номер МЧД и ИНН доверителя или признак «использовать МЧД по умолчанию». Эти методы принимают на вход структуры :doc:`../proto/SignedContent` и :doc:`../proto/DocumentSenderSignature`, которые хранят информацию о МЧД внутри структуры :doc:`../proto/PowerOfAttorneyToPost`.


Получение документа
-------------------
 
Получение МЧД в сообщении
~~~~~~~~~~~~~~~~~~~~~~~~~

Чтобы получить информацию о МЧД в сообщении, используйте методы

- :doc:`../http/GetMessage`,
- :doc:`../http/GetNewEvents`,
- :doc:`../http/GetLastEvent`,
- :doc:`../http/GetEvent`.

Они возвращают информацию о МЧД и ее статусе внутри структуры :doc:`../proto/PowerOfAttorneyInfo`.

Получение МЧД в docflow
~~~~~~~~~~~~~~~~~~~~~~~

Чтобы получить информацию о МЧД в docflow, используйте методы

- :doc:`V3/GetDocflowEvents <../http/GetDocflowEvents_V3>`,
- :doc:`V3/GetDocflows <../http/GetDocflows_V3>`,
- :doc:`V3/GetDocflowsByPacketId <../http/GetDocflowsByPacketId_V3>`,
- :doc:`V3/SearchDocflows <../http/SearchDocflows_V3>`.

Они возвращают:

- информацию об общем (сводном) статусе по всем МЧД для всех сущностей документа внутри структуры :doc:`../proto/PowerOfAttorneyValidationStatus`, хранящейся в :doc:`../proto/DocflowStatusV3`,
- информацию о МЧД и ее статусе из подписи под документом внутри структуры :doc:`../proto/SignaturePowerOfAttorney`, хранящейся в :doc:`../proto/SignatureV3`.

Получение МЧД в документах
~~~~~~~~~~~~~~~~~~~~~~~~~~

Чтобы получить информацию о МЧД в документах, используйте методы

- :doc:`../http/GetDocument`,
- :doc:`../http/GetDocuments`,
- :doc:`../http/GetDocumentsByMessageId`.

Они возвращают информацию об общем (сводном) статусе по всем МЧД для всех сущностей документа внутри структуры :doc:`../proto/PowerOfAttorneyValidationStatus`, хранящейся в :doc:`../proto/DocflowStatusV3`.

Чтобы получить информацию о МЧД, отправленной с документом, используйте метод :doc:`../http/GetPowerOfAttorneyInfo`.


Ответное действие по документу
------------------------------

Для ответного действия по документу вызовите метод :doc:`../http/PostMessagePatch`, указав в теле запроса регистрационный номер МЧД и ИНН доверителя или признак «использовать МЧД по умолчанию». Этот метод принимает на вход структуру :doc:`../proto/DocumentSignature`, которая хранят информацию о МЧД внутри структуры :doc:`../proto/PowerOfAttorneyToPost`.